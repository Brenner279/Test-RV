<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Amapa Interativo: Historia 360</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-environment-component@1.5.x/dist/aframe-environment-component.min.js"></script>
  <script>
    /* --- LÓGICA DO SISTEMA --- */
    
    const db = {
      'vitoria': {
        nome: 'Vitoria do Jari',
        conteudos: {
          // NOTA: Para funcionar perfeito, o video deve ser gravado em 360 (equiretangular)
          'Historia': { t: 'Historia', txt: '', video: './assets/videos/vitoria_360.mp4', tipo: 'video360' },
          'Cultura': { t: 'Cultura', txt: 'Olhe para o PLAY', narra: './assets/audios/vitoria.mp3', tipo: 'audio' },
          'Turismo': { t: 'Turismo', txt: 'Visualizando turismo', imagemPainel: './assets/imagens/vitoria.png', tipo: 'imagem' }
        }
      },
      'macapa': { nome: 'Macapa', conteudos: { 'historia': {t:'EM BREVE', txt:'Indisponivel'} } },
      // ... (outras cidades mantidas iguais)
      'laranjal do jari': { nome: 'Laranjal do Jari', conteudos: { 'historia': {t:'EM BREVE', txt:'Indisponivel'} } },
      'oiapoque': { nome: 'Oiapoque', conteudos: { 'historia': {t:'EM BREVE', txt:'Indisponivel'} } },
      'serra do navio': { nome: 'Serra do Navio', conteudos: { 'historia': {t:'EM BREVE', txt:'Indisponivel'} } },
      'santana': { nome: 'Santana', conteudos: { 'historia': {t:'EM BREVE', txt:'Indisponivel'} } },
      'amapa': { nome: 'Amapa', conteudos: { 'historia': {t:'EM BREVE', txt:'Indisponivel'} } },
    };

    let cidadeAtual = '';
    let audioNarracao = null;

    window.onload = function() {
      gerarMenuCidades();
    };

    function gerarMenuCidades() {
      const container = document.getElementById('grade-cidades');
      const chaves = Object.keys(db);
      let col = 0; let row = 0;
      const chavesPorLinha = 3;

      chaves.forEach((chave) => {
        const cidade = db[chave];
        const x = (col * 1.1) - 1.1; 
        const y = 0.8 - (row * 0.5); 
        
        const el = document.createElement('a-entity');
        el.setAttribute('position', `${x} ${y} 0`);
        el.innerHTML = `
          <a-plane color="#FFD700" width="1" height="0.4" class="clickable interativo"
            onclick="selecionarCidade('${chave}')"
            animation__scale="property: scale; to: 1.1 1.1 1.1; dur: 200; startEvents: mouseenter"
            animation__out="property: scale; to: 1 1 1; dur: 200; startEvents: mouseleave">
             <a-text value="${cidade.nome}" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center" color="#333" width="2.8" z-offset="0.01"></a-text>
          </a-plane>`;
        container.appendChild(el);
        col++; if (col >= chavesPorLinha) { col = 0; row++; }
      });
    }

    function irPara(idGrupo) {
      // Oculta grupos normais
      ['grupo-inicio', 'grupo-cidades', 'grupo-categorias', 'grupo-player'].forEach(g => {
        const el = document.getElementById(g);
        el.setAttribute('visible', 'false');
        el.querySelectorAll('.interativo').forEach(b => b.classList.remove('clickable'));
      });

      // Garante que o modo 360 esteja desligado ao navegar pelos menus normais
      desativarModo360();

      const destino = document.getElementById(idGrupo);
      destino.setAttribute('visible', 'true');
      destino.querySelectorAll('.interativo').forEach(b => b.classList.add('clickable'));

      trocarAmbiente(idGrupo); // Mantém sua lógica de ambientes
      
      if(idGrupo !== 'grupo-player') pararTudo();
    }

    function trocarAmbiente(idGrupo) {
        const ambienteEl = document.getElementById('ambiente-3d');
        // Se estivermos vendo video 360, o ambiente deve ficar invisível
        if(document.getElementById('videosphere').getAttribute('visible') == true) return;

        ambienteEl.setAttribute('visible', 'true');
        
        let preset = 'forest';
        let chao = '#445';
        switch(idGrupo) {
            case 'grupo-inicio': preset = 'forest'; break;
            case 'grupo-cidades': preset = 'arches'; break;
            case 'grupo-categorias': preset = 'volcano'; break;
            case 'grupo-player': preset = 'starry'; chao = '#111'; break;
        }
        ambienteEl.setAttribute('environment', { preset: preset, groundColor: chao, grid: 'cross', playArea: 1 });
    }

    function selecionarCidade(chave) {
      cidadeAtual = chave;
      document.getElementById('titulo-cidade-cat').setAttribute('value', db[chave].nome);
      irPara('grupo-categorias');
    }

    function verConteudo(tipo) {
      if(!db[cidadeAtual].conteudos[tipo]) return;
      const dados = db[cidadeAtual].conteudos[tipo];
      
      pararTudo();

      // --- NOVA LÓGICA PARA VIDEO 360 (HISTORIA) ---
      if (dados.tipo === 'video360') {
          ativarModo360(dados.video);
          return; // Para a função aqui, não executa o resto do player padrão
      }
      
      // Player Padrão (2D)
      const videoEl = document.getElementById('video-player');
      const telaVideo = document.getElementById('vr-video-screen');
      const imgPainel = document.getElementById('vr-imagem-screen');
      const controles = document.getElementById('controles-media');
      
      telaVideo.setAttribute('visible', 'false');
      imgPainel.setAttribute('visible', 'false');
      controles.setAttribute('visible', 'false');
      
      document.getElementById('vr-titulo').setAttribute('value', dados.t);
      document.getElementById('vr-texto').setAttribute('value', dados.txt || '');

      if (dados.tipo === 'audio' && dados.narra) {
         audioNarracao = new Audio(dados.narra);
         controles.setAttribute('visible', 'true');
      }
      else if (dados.tipo === 'imagem' && dados.imagemPainel) {
         imgPainel.setAttribute('src', dados.imagemPainel);
         imgPainel.setAttribute('visible', 'true');
      }

      irPara('grupo-player');
    }

    // --- FUNÇÕES ESPECIFICAS PARA O MODO 360 ---

    function ativarModo360(srcVideo) {
        // 1. Esconde tudo que é do menu padrão
        ['grupo-inicio', 'grupo-cidades', 'grupo-categorias', 'grupo-player'].forEach(g => {
            document.getElementById(g).setAttribute('visible', 'false');
            document.getElementById(g).querySelectorAll('.interativo').forEach(b => b.classList.remove('clickable'));
        });

        // 2. Esconde o ambiente gerado (forest/arches)
        document.getElementById('ambiente-3d').setAttribute('visible', 'false');

        // 3. Prepara o video
        const videoEl = document.getElementById('video-player');
        videoEl.setAttribute('src', srcVideo);
        
        // 4. Ativa a esfera 360
        const videosphere = document.getElementById('videosphere');
        videosphere.setAttribute('visible', 'true');

        // 5. Ativa o HUD (controles na cara)
        const hud = document.getElementById('hud-controles');
        hud.setAttribute('visible', 'true');
        hud.querySelectorAll('.interativo').forEach(b => b.classList.add('clickable'));

        // Play automático e ajusta botões
        videoEl.play();
        atualizarBotoesHUD(true);
    }

    function desativarModo360() {
        const videosphere = document.getElementById('videosphere');
        const hud = document.getElementById('hud-controles');
        const ambienteEl = document.getElementById('ambiente-3d');

        // Pausa video e esconde 360
        pararTudo();
        videosphere.setAttribute('visible', 'false');
        
        // Esconde HUD
        hud.setAttribute('visible', 'false');
        hud.querySelectorAll('.interativo').forEach(b => b.classList.remove('clickable'));

        // Restaura ambiente
        ambienteEl.setAttribute('visible', 'true');
    }

    function togglePlay360() {
        const videoEl = document.getElementById('video-player');
        if (videoEl.paused) {
            videoEl.play();
            atualizarBotoesHUD(true);
        } else {
            videoEl.pause();
            atualizarBotoesHUD(false);
        }
    }

    function atualizarBotoesHUD(estaTocando) {
        const btnPlay = document.getElementById('hud-btn-play');
        const txtPlay = document.getElementById('hud-txt-play');
        
        if(estaTocando) {
            btnPlay.setAttribute('color', 'red');
            txtPlay.setAttribute('value', 'PAUSE');
        } else {
            btnPlay.setAttribute('color', 'green');
            txtPlay.setAttribute('value', 'PLAY');
        }
    }

    function sairDo360() {
        desativarModo360();
        // Volta para a seleção de categorias da cidade atual
        irPara('grupo-categorias'); 
    }

    // --- FUNÇÕES PLAYER PADRÃO (MANTIDAS) ---
    function togglePlay() { /* ... igual ao anterior ... */ 
       // Simplifiquei aqui só para não ficar gigante, use a lógica antiga se precisar do audio player também
       const videoEl = document.getElementById('video-player');
       if(videoEl.paused) videoEl.play(); else videoEl.pause();
    }
    
    function restartMedia() {
       const v = document.getElementById('video-player');
       v.currentTime = 0; v.play();
    }

    function pararTudo() {
      const v = document.getElementById('video-player');
      v.pause();
      if(audioNarracao) { audioNarracao.pause(); }
    }

  </script>
</head>
<body>

  <a-scene background="color: #111">

    <a-entity id="ambiente-3d" environment="preset: forest; groundColor: #445; grid: cross"></a-entity>
    
    <a-videosphere id="videosphere" src="#video-player" visible="false" rotation="0 -90 0"></a-videosphere>

    <a-assets>
       <video id="video-player" loop="true" crossorigin="anonymous" playsinline webkit-playsinline></video>
    </a-assets>

    <a-camera position="0 1.1 0">
        <a-cursor
          id="cursor" color="#FF0000" fuse="true" fuse-timeout="1500"
          geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
          raycaster="objects: .clickable; far: 20"
          animation__fusing="property: scale; startEvents: fusing; easing: easeInCubic; dur: 1500; from: 1 1 1; to: 0.1 0.1 0.1"
          animation__leave="property: scale; startEvents: mouseleave; to: 1 1 1; dur: 200">
        </a-cursor>

        <a-entity id="hud-controles" position="0 -0.4 -1" visible="false">
            
            <a-entity position="-0.3 0 0">
                <a-circle id="hud-btn-play" radius="0.1" color="green" class="interativo" onclick="togglePlay360()"></a-circle>
                <a-text id="hud-txt-play" value="PLAY" align="center" position="0 -0.15 0" width="2"></a-text>
            </a-entity>

            <a-entity position="0.3 0 0">
                <a-circle radius="0.1" color="#444" class="interativo" onclick="sairDo360()"></a-circle>
                <a-text value="VOLTAR" align="center" position="0 -0.15 0" width="2"></a-text>
            </a-entity>

            <a-plane position="0 -0.05 0.05" width="1" height="0.4" color="black" opacity="0.5" rotation="0 0 0"></a-plane>
        </a-entity>

    </a-camera>

    <a-entity id="grupo-inicio" visible="true">
        <a-text value="Amapa Interativo" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center" position="0 3 -3" width="10" color="#000000"></a-text>
        <a-plane position="0 1.6 -3" width="1.5" height="0.6" color="#004d40" class="clickable interativo" onclick="irPara('grupo-cidades')">
            <a-text value="INICIAR" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center" width="6"></a-text>
        </a-plane>
    </a-entity>

    <a-entity id="grupo-cidades" visible="false">
        <a-entity id="grade-cidades" position="0 2 -3"></a-entity>
        <a-plane position="0 1.2 -3" width="1" height="0.4" color="#444" class="interativo" onclick="irPara('grupo-inicio')">
            <a-text value="VOLTAR" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center"></a-text>
        </a-plane>
    </a-entity>

    <a-entity id="grupo-categorias" visible="false">
        <a-text id="titulo-cidade-cat" value="CIDADE" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center" position="0 3 -3" width="10" color="#000000" ></a-text>
        <a-plane position="-1.2 2 -3" width="1.2" height="0.8" color="#004d40" class="interativo" onclick="verConteudo('Historia')">
            <a-text value="Historia (360)" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center" width="6"></a-text>
        </a-plane>
        <a-plane position="0 2 -3" width="1.2" height="0.8" color="#E64A19" class="interativo" onclick="verConteudo('Cultura')">
            <a-text value="Cultura" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center" width="6"></a-text>
        </a-plane>
        <a-plane position="1.2 2 -3" width="1.2" height="0.8" color="#388E3C" class="interativo" onclick="verConteudo('Turismo')">
            <a-text value="Turismo" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center" width="6"></a-text>
        </a-plane>
        <a-plane position="1.5 1 -3" width="1" height="0.3" color="#444" class="interativo" onclick="irPara('grupo-cidades')">
            <a-text value="VOLTAR" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center"></a-text>
        </a-plane>
    </a-entity>

    <a-entity id="grupo-player" visible="false">
        <a-plane position="0 1.5 -3" width="3" height="2.5" color="#111" opacity="0.95"></a-plane>
        <a-text id="vr-titulo" value="TITULO" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center" position="0 2.5 -2.9" color="#FFD700" width="4"></a-text>
        <a-video id="vr-video-screen" src="#video-player" width="2" height="1" position="0 1.8 -2.9" visible="false"></a-video>
        <a-image id="vr-imagem-screen" width="2" height="1" position="0 1.8 -2.9" visible="false"></a-image>
        
        <a-entity id="controles-media" position="0 1 -2.9" visible="false">
            <a-circle id="btn-play-cor" radius="0.20" color="green" class="interativo" onclick="togglePlay()"></a-circle>
        </a-entity>

        <a-text id="vr-texto" value="Texto..." font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center" position="0 0.4 -2.8" width="3.5"></a-text>
        <a-plane position="0 0.15 -2.9" width="1" height="0.25" color="#444" class="interativo" onclick="irPara('grupo-categorias')">
            <a-text value="VOLTAR" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" align="center"></a-text>
        </a-plane>
    </a-entity>

  </a-scene>
</body>
</html>
