<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Explora AP - VR Final</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  
  <script>
    /* --- LÓGICA DO SISTEMA --- */
    
    // Banco de Dados
    const db = {
      'vitoria': {
        nome: 'Vitória do Jari',
        conteudos: {
          'historia': { t: 'VIDEO DA CIDADE', txt: 'Olhe para o PLAY', video: './assets/videos/vitoria.mp4', tipo: 'video' },
          'culinaria': { t: 'HINO MUNICIPAL', txt: 'Olhe para o PLAY', narra: './assets/audios/vitoria.mp3', tipo: 'audio' },
          'mapa': { t: 'BANDEIRA', txt: 'Visualizando bandeira', imagemPainel: './assets/imagens/vitoria.png', tipo: 'imagem' }
        }
      },
      'macapa': { nome: 'Macapá', conteudos: { 'historia': {t:'EM BREVE', txt:'Indisponivel'} } },
      'santana': { nome: 'Santana', conteudos: { 'historia': {t:'EM BREVE', txt:'Indisponivel'} } },
      'amapa': { nome: 'Amapá', conteudos: { 'historia': {t:'EM BREVE', txt:'Indisponivel'} } },
      'mazagao': { nome: 'Mazagão', conteudos: { 'historia': {t:'EM BREVE', txt:'Indisponivel'} } },
      'oiapoque': { nome: 'Oiapoque', conteudos: { 'historia': {t:'EM BREVE', txt:'Indisponivel'} } },
    };

    let cidadeAtual = '';
    let audioNarracao = null;
    let previewVideo = null;
    let previewTimeout = null;

    // --- INICIALIZAÇÃO ---
    window.onload = function() {
      gerarMenuCidades();
    };

    // Gera os botões flutuantes das cidades
    function gerarMenuCidades() {
      const container = document.getElementById('grade-cidades');
      const chaves = Object.keys(db);
      
      let col = 0; let row = 0;
      const chavesPorLinha = 3;

      chaves.forEach((chave) => {
        const cidade = db[chave];
        
        const x = (col * 1.1) - 1.1;
        const y = 1.5 - (row * 0.6);
        
        const el = document.createElement('a-entity');
        el.setAttribute('position', `${x} ${y} 0`);
        
        el.innerHTML = `
          <a-plane 
            color="#FFD700" 
            width="1" height="0.4" 
            class="clickable interativo" 
            onclick="selecionarCidade('${chave}')"
            animation__scale="property: scale; to: 1.1 1.1 1.1; dur: 200; startEvents: mouseenter"
            animation__out="property: scale; to: 1 1 1; dur: 200; startEvents: mouseleave">
             <a-text value="${cidade.nome}" align="center" color="#333" width="2.8" z-offset="0.01"></a-text>
          </a-plane>
        `;
        container.appendChild(el);

        col++;
        if (col >= chavesPorLinha) { col = 0; row++; }
      });
    }

    // --- SISTEMA DE NAVEGAÇÃO ---
    function irPara(idGrupo) {
      // Para o preview ao mudar de tela
      pararPreviewVideo();
      
      const grupos = ['grupo-inicio', 'grupo-cidades', 'grupo-categorias', 'grupo-player'];
      
      grupos.forEach(g => {
        const el = document.getElementById(g);
        el.setAttribute('visible', 'false');
        const botoes = el.querySelectorAll('.interativo');
        botoes.forEach(b => b.classList.remove('clickable'));
      });

      const destino = document.getElementById(idGrupo);
      destino.setAttribute('visible', 'true');
      const botoesAtivos = destino.querySelectorAll('.interativo');
      botoesAtivos.forEach(b => b.classList.add('clickable'));

      if(idGrupo !== 'grupo-player') {
        pararTudo();
      }
    }

    function selecionarCidade(chave) {
      cidadeAtual = chave;
      document.getElementById('titulo-cidade-cat').setAttribute('value', db[chave].nome);
      irPara('grupo-categorias');
    }

    // --- FUNÇÕES PARA PREVIEW DE VÍDEO ---
    function iniciarPreviewVideo() {
      // Limpa timeout anterior
      if (previewTimeout) {
        clearTimeout(previewTimeout);
      }
      
      // Aguarda 300ms para evitar ativação acidental
      previewTimeout = setTimeout(function() {
        if(!cidadeAtual) return;
        
        const dados = db[cidadeAtual].conteudos['historia'];
        if(!dados || dados.tipo !== 'video' || !dados.video) return;
        
        // Para qualquer preview anterior
        pararPreviewVideo();
        
        // Cria elemento de vídeo para preview
        previewVideo = new Video();
        previewVideo.src = dados.video;
        previewVideo.loop = true;
        previewVideo.crossOrigin = "anonymous";
        previewVideo.playsInline = true;
        previewVideo.muted = true;
        previewVideo.volume = 0; // Garante que está sem áudio
        
        // Configura o elemento na cena
        const previewScreen = document.getElementById('preview-screen');
        previewScreen.setAttribute('src', dados.video);
        previewScreen.setAttribute('visible', 'true');
        
        // Tenta reproduzir
        previewVideo.load();
        previewVideo.play().then(() => {
          console.log("Preview iniciado");
        }).catch(error => {
          console.log("Autoplay bloqueado, tentando com mute...");
          // Tenta com mute explícito
          previewVideo.muted = true;
          previewVideo.play().catch(e => {
            console.log("Ainda não pode reproduzir:", e);
          });
        });
        
      }, 300);
    }

    function pararPreviewVideo() {
      // Limpa o timeout
      if (previewTimeout) {
        clearTimeout(previewTimeout);
        previewTimeout = null;
      }
      
      // Para o vídeo
      if(previewVideo) {
        previewVideo.pause();
        previewVideo = null;
      }
      
      // Esconde a tela de preview
      const previewScreen = document.getElementById('preview-screen');
      previewScreen.setAttribute('visible', 'false');
      previewScreen.removeAttribute('src');
    }

    // --- LÓGICA DE MÍDIA ---
    function verConteudo(tipo) {
      // Para o preview ao entrar no player
      pararPreviewVideo();
      
      if(!db[cidadeAtual].conteudos[tipo]) return;

      const dados = db[cidadeAtual].conteudos[tipo];
      
      const videoEl = document.getElementById('video-player');
      const telaVideo = document.getElementById('vr-video-screen');
      const imgPainel = document.getElementById('vr-imagem-screen');
      const controles = document.getElementById('controles-media');
      const titulo = document.getElementById('vr-titulo');
      const texto = document.getElementById('vr-texto');

      pararTudo();
      telaVideo.setAttribute('visible', 'false');
      imgPainel.setAttribute('visible', 'false');
      controles.setAttribute('visible', 'false');
      
      titulo.setAttribute('value', dados.t);
      texto.setAttribute('value', dados.txt || '');

      // 1. É VIDEO?
      if (dados.tipo === 'video' && dados.video) {
         videoEl.setAttribute('src', dados.video);
         telaVideo.setAttribute('visible', 'true');
         controles.setAttribute('visible', 'true');
         
         // Configura para reproduzir automaticamente
         videoEl.play().then(() => {
           document.getElementById('btn-play-cor').setAttribute('color', 'red');
           document.getElementById('btn-play-txt').setAttribute('value', 'PAUSE');
         }).catch(e => {
           console.log("Autoplay bloqueado no player principal");
           document.getElementById('btn-play-cor').setAttribute('color', 'green');
           document.getElementById('btn-play-txt').setAttribute('value', 'PLAY');
         });
      }
      // 2. É AUDIO?
      else if (dados.tipo === 'audio' && dados.narra) {
         audioNarracao = new Audio(dados.narra);
         controles.setAttribute('visible', 'true');
         
         document.getElementById('btn-play-cor').setAttribute('color', 'green');
         document.getElementById('btn-play-txt').setAttribute('value', 'PLAY');
      }
      // 3. É IMAGEM?
      else if (dados.tipo === 'imagem' && dados.imagemPainel) {
         imgPainel.setAttribute('src', dados.imagemPainel);
         imgPainel.setAttribute('visible', 'true');
      }

      irPara('grupo-player');
    }

    function togglePlay() {
      const videoEl = document.getElementById('video-player');
      const btnCor = document.getElementById('btn-play-cor');
      const btnTxt = document.getElementById('btn-play-txt');

      // Lógica Vídeo
      if (videoEl.getAttribute('src')) {
        if (videoEl.paused) {
          videoEl.play();
          btnCor.setAttribute('color', 'red');
          btnTxt.setAttribute('value', 'PAUSE');
        } else {
          videoEl.pause();
          btnCor.setAttribute('color', 'green');
          btnTxt.setAttribute('value', 'PLAY');
        }
      }
      
      // Lógica Áudio
      if (audioNarracao) {
        if (audioNarracao.paused) {
          audioNarracao.play();
          btnCor.setAttribute('color', 'red');
          btnTxt.setAttribute('value', 'PAUSE');
        } else {
          audioNarracao.pause();
          btnCor.setAttribute('color', 'green');
          btnTxt.setAttribute('value', 'PLAY');
        }
      }
    }

    function restartMedia() {
      const videoEl = document.getElementById('video-player');
      if (videoEl.getAttribute('src')) {
        videoEl.currentTime = 0;
        videoEl.play();
      }
      if (audioNarracao) {
        audioNarracao.currentTime = 0;
        audioNarracao.play();
      }
      document.getElementById('btn-play-cor').setAttribute('color', 'red');
      document.getElementById('btn-play-txt').setAttribute('value', 'PAUSE');
    }

    function pararTudo() {
      const v = document.getElementById('video-player');
      v.pause();
      v.removeAttribute('src');
      
      if(audioNarracao) {
        audioNarracao.pause();
        audioNarracao = null;
      }
    }

  </script>
</head>
<body>

  <a-scene background="color: #111">
    
    <a-assets>
       <video id="video-player" loop="true" crossorigin="anonymous" playsinline webkit-playsinline></video>
    </a-assets>

    <a-camera position="0 1.6 0">
        <a-cursor 
          id="cursor"
          color="#FFD700"
          fuse="true" 
          fuse-timeout="1500"
          geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
          raycaster="objects: .clickable; far: 20"
          animation__fusing="property: scale; startEvents: fusing; easing: easeInCubic; dur: 1500; from: 1 1 1; to: 0.1 0.1 0.1"
          animation__leave="property: scale; startEvents: mouseleave; to: 1 1 1; dur: 200">
        </a-cursor>
    </a-camera>


    <a-entity id="grupo-inicio" visible="true">
        <a-text value="EXPLORA AP" align="center" position="0 2.5 -3" width="10" color="#FFD700"></a-text>
        <a-text value="Patrimonio Cultural em VR" align="center" position="0 2 -3" width="5"></a-text>
        
        <a-plane position="0 1 -3" width="1.5" height="0.6" color="#004d40" class="clickable interativo" onclick="irPara('grupo-cidades')">
            <a-text value="INICIAR" align="center" width="6"></a-text>
        </a-plane>
    </a-entity>


    <a-entity id="grupo-cidades" visible="false">
        <a-text value="ESCOLHA O DESTINO" align="center" position="0 2.8 -3" width="8" color="#FFD700"></a-text>
        
        <a-entity id="grade-cidades" position="0 0.5 -3"></a-entity>

        <a-plane position="0 -1.2 -3" width="1" height="0.4" color="#444" class="interativo" onclick="irPara('grupo-inicio')">
            <a-text value="VOLTAR" align="center"></a-text>
        </a-plane>
    </a-entity>


    <a-entity id="grupo-categorias" visible="false">
        <a-text id="titulo-cidade-cat" value="CIDADE" align="center" position="0 2.5 -3" width="10" color="#FFD700"></a-text>

        <!-- Vídeo de preview (inicialmente invisível) -->
        <a-video id="preview-screen" width="2" height="1.2" 
                 position="0 0.2 -2.9" visible="false" opacity="0.9"></a-video>

        <a-plane position="-1.2 1 -3" width="1" height="1" color="#004d40" 
                 class="interativo" 
                 id="btn-video"
                 onclick="verConteudo('historia')"
                 onmouseenter="iniciarPreviewVideo()"
                 onmouseleave="pararPreviewVideo()">
            <a-text value="VIDEO" align="center" width="6"></a-text>
        </a-plane>

        <a-plane position="0 1 -3" width="1" height="1" color="#E64A19" class="interativo" onclick="verConteudo('culinaria')">
            <a-text value="HINO" align="center" width="6"></a-text>
        </a-plane>

        <a-plane position="1.2 1 -3" width="1" height="1" color="#388E3C" class="interativo" onclick="verConteudo('mapa')">
            <a-text value="BANDEIRA" align="center" width="6"></a-text>
        </a-plane>

        <a-plane position="0 -0.5 -3" width="1" height="0.3" color="#444" class="interativo" onclick="irPara('grupo-cidades')">
            <a-text value="VOLTAR" align="center"></a-text>
        </a-plane>
    </a-entity>


    <a-entity id="grupo-player" visible="false">
        
        <a-plane position="0 1.6 -3" width="3.5" height="2.5" color="#111" opacity="0.95"></a-plane>
        
        <a-text id="vr-titulo" value="TITULO" align="center" position="0 2.6 -2.9" color="#FFD700" width="6"></a-text>
        <a-text id="vr-texto" value="Olhe para o Play..." align="center" position="0 0.6 -2.9" width="3.5"></a-text>

        <a-video id="vr-video-screen" src="#video-player" width="3" height="1.6" position="0 1.6 -2.9" visible="false"></a-video>
        
        <a-image id="vr-imagem-screen" width="2" height="1.4" position="0 1.6 -2.85" visible="false"></a-image>

        <a-entity id="controles-media" position="0 0 -2.9" visible="false">
            
            <a-entity position="-0.5 0 0" class="interativo" onclick="togglePlay()">
               <a-circle id="btn-play-cor" radius="0.25" color="green"
                 animation__sc="property: scale; to: 1.2 1.2 1.2; dur: 200; startEvents: mouseenter"
                 animation__out="property: scale; to: 1 1 1; dur: 200; startEvents: mouseleave">
               </a-circle>
               <a-text id="btn-play-txt" value="PLAY" align="center" position="0 -0.4 0"></a-text>
            </a-entity>

            <a-entity position="0.5 0 0" class="interativo" onclick="restartMedia()">
               <a-circle radius="0.25" color="#0055ff"
                 animation__sc="property: scale; to: 1.2 1.2 1.2; dur: 200; startEvents: mouseenter"
                 animation__out="property: scale; to: 1 1 1; dur: 200; startEvents: mouseleave">
               </a-circle>
               <a-text value="RESTART" align="center" position="0 -0.4 0"></a-text>
            </a-entity>
        </a-entity>

        <a-plane position="0 -1.2 -3" width="1" height="0.4" color="#444" class="interativo" onclick="irPara('grupo-categorias')">
            <a-text value="VOLTAR" align="center"></a-text>
        </a-plane>
    </a-entity>

  </a-scene>
</body>
</html>
